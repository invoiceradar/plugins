{
  "$schema": "https://raw.githubusercontent.com/invoiceradar/plugins/main/schema.json",
  "id": "fiverr",
  "name": "Fiverr",
  "description": "Fiverr is a platform to find and hire freelancers.",
  "homepage": "https://www.fiverr.com/",
  "checkAuth": [
    {
      "action": "navigate",
      "url": "https://www.fiverr.com/login"
    },
    {
      "action": "waitForElement",
      "selector": ".main-content"
    },
    {
      "action": "checkElementExists",
      "selector": "[name='user_id']"
    }
  ],
  "startAuth": [
    {
      "action": "navigate",
      "url": "https://www.fiverr.com/login"
    },
    {
      "action": "waitForElement",
      "selector": "[name='user_id']",
      "timeout": 120000
    },
    {
      "action": "waitForCondition",
      "script": "window.location.pathname === '/'",
      "timeout": 120000
    }
  ],
  "getDocuments": [
    {
      "action": "navigate",
      "url": "https://www.fiverr.com/billing"
    },
    {
      "action": "extract",
      "script": "window.location.href.includes('pro.fiverr.com')",
      "variable": "isPro",
      "scopeSelector": true
    },
    {
      "action": "extract",
      "variable": "invoiceData",
      "script": "(() => {\n  const context = '{{isPro}}' === 'true' ? 'team' : 'user'\n\n  return fetch(\n    `/perseus/financial-dashboard/api/billing/get-invoices?pageSize=250&pageNumber=1&contextType=${context}`,\n    {\n      headers: {\n        accept: 'application/json',\n        'accept-language': 'en',\n        'x-requested-with': 'XMLHttpRequest',\n      },\n      method: 'GET',\n      mode: 'cors',\n      credentials: 'include',\n    },\n  )\n    .then((r) => r.json())\n    .then((data) =>\n      data.paged_results.map((r) => ({\n        ...r,\n        total_amount: r.total_amount / 100,\n      })),\n    )\n})()",
      "scopeSelector": true
    },
    {
      "action": "extractAll",
      "script": "{{invoiceData}}",
      "variable": "invoice",
      "forEach": [
        {
          "action": "if",
          "script": "'{{invoice.transaction_type}}' === 'INVOICE'",
          "then": [
            {
              "action": "downloadPdf",
              "url": "https://www.fiverr.com{{invoice.download_url}}",
              "document": {
                "type": "invoice",
                "id": "{{invoice.id}}",
                "date": "{{invoice.transaction_date}}",
                "total": "{{invoice.total_amount}}",
                "currency": "{{invoice.currency}}"
              }
            }
          ],
          "else": [
            {
              "action": "downloadPdf",
              "url": "https://www.fiverr.com{{invoice.download_url}}",
              "document": {
                "type": "refund",
                "id": "{{invoice.id}}",
                "date": "{{invoice.transaction_date}}",
                "total": "{{invoice.total_amount}}",
                "currency": "{{invoice.currency}}"
              }
            }
          ],
          "scopeSelector": true
        }
      ]
    }
  ],
  "autofill": true
}
