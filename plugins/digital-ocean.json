{
  "$schema": "https://raw.githubusercontent.com/invoiceradar/plugins/main/schema.json",
  "id": "digital-ocean",
  "name": "DigitalOcean",
  "description": "DigitalOcean is a cloud infrastructure provider.",
  "homepage": "https://www.digitalocean.com",
  "configSchema": {
    "teamId": {
      "type": "string",
      "title": "Team ID",
      "required": true,
      "description": "You can find your team ID in the URL. 'cloud.digitalocean.com/projects?i=<teamId>'"
    }
  },
  "checkAuth": [
    {
      "action": "navigate",
      "url": "https://cloud.digitalocean.com/"
    },
    {
      "action": "checkURL",
      "url": "/projects**"
    }
  ],
  "startAuth": [
    {
      "action": "navigate",
      "url": "https://cloud.digitalocean.com/login"
    },
    {
      "action": "waitForElement",
      "selector": "nav .account",
      "timeout": 120000
    }
  ],
  "getConfigOptions": [
    {
      "action": "navigate",
      "url": "https://cloud.digitalocean.com",
      "waitForNetworkIdle": true
    },
    {
      "action": "waitForCondition",
      "script": "window.currentUser?.organizations?.length > 0"
    },
    {
      "action": "extractAll",
      "script": "window.currentUser.organizations.map((org) => ({\n  label: org.name,\n  value: org.uuid.substring(0, 6),\n}))",
      "variable": "option",
      "forEach": [
        {
          "action": "exposeOption",
          "config": "teamId",
          "option": "{{option}}"
        }
      ]
    }
  ],
  "getDocuments": [
    {
      "action": "navigate",
      "url": "https://cloud.digitalocean.com/projects?i={{config.teamId}}"
    },
    {
      "action": "extractAll",
      "script": "fetch('https://cloud.digitalocean.com/graphql?i={{config.teamId}}', {\n  method: 'POST',\n  credentials: 'include',\n  headers: {\n    'accept': '*/*',\n    'accept-language': 'en',\n    'apollographql-client-name': 'ui-billing',\n    'apollographql-client-version': '2025.12.10-d315ece2fbf9f4e3aa5a7f0eb5c5ec215e29c59a',\n    'content-type': 'application/json'\n  },\n  body: JSON.stringify({\n    operationName: 'listBillingHistory',\n    variables: { listBillingHistoryRequest: { page: 1, per_page: 100 } },\n    query: `query listBillingHistory($listBillingHistoryRequest: ListBillingHistoryRequest) {\n  listBillingHistory(ListBillingHistoryRequest: $listBillingHistoryRequest) {\n    billing_history {\n      description\n      amount\n      invoice_id\n      invoice_uuid\n      date\n      type\n      memo_id\n      receipt_id\n      project_spend_report_available\n      account_urn\n      __typename\n    }\n    meta {\n      total\n      __typename\n    }\n    __typename\n  }\n}`,\n  }),\n})\n  .then((res) => res.json())\n  .then((res) =>\n    res.data.listBillingHistory.billing_history.filter(\n      (item) => !!item.invoice_id,\n    ),\n  )\n  .then((items) =>\n    items.map((item) => ({\n      id: item.invoice_id,\n      date: item.date,\n      total: 'USD ' + item.amount,\n      invoice_uuid: item.invoice_uuid,\n    })),\n  )",
      "variable": "item",
      "forEach": [
        {
          "action": "extract",
          "variable": "base64Pdf",
          "script": "fetch('https://cloud.digitalocean.com/graphql?i={{config.teamId}}', {\n  method: 'POST',\n  credentials: 'include',\n  headers: {\n    'accept': '*/*',\n    'accept-language': 'en',\n    'apollographql-client-name': 'ui-billing',\n    'apollographql-client-version': '2025.12.10-d315ece2fbf9f4e3aa5a7f0eb5c5ec215e29c59a',\n    'content-type': 'application/json'\n  },\n  body: JSON.stringify({\n    operationName: 'getInvoicePDF',\n    variables: {\n      request: {\n        invoice_uuid: '{{item.invoice_uuid}}',\n      },\n    },\n    query: `query getInvoicePDF($request: GetInvoicePDFRequest) {\n  download: getInvoicePDF(GetInvoicePDFRequest: $request) {\n    content_type\n    filename\n    data\n    __typename\n  }\n}`,\n  }),\n})\n  .then((res) => res.json())\n  .then((result) => result.data.download.data)",
          "scopeSelector": true
        },
        {
          "action": "downloadBase64Pdf",
          "base64": "{{base64Pdf}}",
          "document": {
            "id": "{{item.id}}",
            "date": "{{item.date}}",
            "total": "{{item.total}}"
          }
        }
      ]
    }
  ],
  "autofill": true
}
